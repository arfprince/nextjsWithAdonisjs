name: Frontend CD

on:
  workflow_run:
    workflows:
      - Frontend CI
    types:
      - completed

jobs:
  deploy-frontend:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - name: Download artifact from CI workflow
      uses: actions/github-script@v6
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.payload.workflow_run.id,
          });
          const matchArtifact = artifacts.data.artifacts.find((artifact) => {
            return artifact.name === 'frontend-build';
          });
          if (!matchArtifact) {
            core.setFailed('No frontend-build artifact found');
            return;
          }
          const download = await github.rest.actions.downloadArtifact({
            owner: context.repo.owner,
            repo: context.repo.repo,
            artifact_id: matchArtifact.id,
            archive_format: 'zip',
          });
          const fs = require('fs');
          fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/frontend-build.zip`, Buffer.from(download.data));

    - name: Unzip artifact
      run: |
        unzip frontend-build.zip
        ls -la

    - name: Upload to VPS
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@18.184.128.160 "mkdir -p /var/www/frontend"
        scp -r .next ubuntu@18.184.128.160:/var/www/frontend
    
    - name: Restart Nginx
      run: ssh -o StrictHostKeyChecking=no ubuntu@18.184.128.160 "sudo systemctl reload nginx"
